<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>게시판 관리</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f9f9f9;
      padding: 20px;
      text-align: center;
    }
    .header {
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 800px;
      margin: 0 auto 30px;
    }
    .header-left {
      text-align: left;
    }
    .header-right {
      display: flex;
      gap: 10px;
    }
    .post-list {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .post-item {
      display: flex;
      align-items: center;
      border-bottom: 1px solid #eee;
      padding: 15px;
    }
    .post-item:last-child {
      border-bottom: none;
    }
    .thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      margin-right: 15px;
      flex-shrink: 0;
    }
    .post-info {
      flex-grow: 1;
      text-align: left;
    }
    .title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .date {
      font-size: 0.8rem;
      color: #888;
    }
    .btn {
      padding: 8px 16px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      border: none;
      color: white;
      margin-left: 10px;
    }
    .btn-view {
      background: #3498db;
    }
    .btn-edit {
      background: #2ecc71;
    }
    .btn-delete {
      background: #e74c3c;
    }
    .write-button {
      display: inline-block;
      margin-top: 20px;
      padding: 10px 20px;
      background: #ffa07a;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
    }
    .logout-button {
      padding: 8px 16px;
      background: #888;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .empty-list {
      padding: 40px 0;
      color: #999;
      font-size: 1.1rem;
    }
    .admin-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .admin-email {
      font-size: 0.9rem;
      color: #555;
    }
    .post-actions {
      display: flex;
      gap: 5px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <h1>게시판 관리</h1>
      <div class="admin-info">
        <div class="admin-email" id="adminEmail"></div>
      </div>
    </div>
    <div class="header-right">
      <a href="board.html" class="btn btn-view">게시판 보기</a>
      <button id="logoutBtn" class="logout-button">로그아웃</button>
    </div>
  </div>
  
  <div id="postList" class="post-list">
    <!-- 게시글이 여기에 로드됩니다 -->
    <div class="empty-list">
      게시글을 불러오는 중...
    </div>
  </div>
  
  <a href="write.html" class="write-button">새 글 작성하기 ✍️</a>

  <script>
    const SUPABASE_URL = 'https://lqkglbaqcnwbhvdjhwka.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxxa2dsYmFxY253Ymh2ZGpod2thIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4MDcxMzgsImV4cCI6MjA2MTM4MzEzOH0.c6Vt3XKENy6pDr2nBhJQz-M9tAQ1RZC3oTfg23ftLfI';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // 인증 상태 확인
    checkAuthState();
    
    async function checkAuthState() {
      const { data, error } = await supabase.auth.getSession();
      
      if (!data.session) {
        // 로그인되어 있지 않으면 로그인 페이지로 리다이렉트
        window.location.href = 'login.html';
        return;
      }
      
      // 관리자 이메일 표시
      document.getElementById('adminEmail').textContent = data.session.user.email;
      
      // 게시글 로드
      loadPosts();
    }
    
    // 날짜 포맷 함수
    function formatDate(dateString) {
      const date = new Date(dateString);
      return `${date.getFullYear()}.${date.getMonth() + 1}.${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
    }

    async function loadPosts() {
      const { data, error } = await supabase
        .from('posts')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('불러오기 실패:', error.message);
        const container = document.getElementById('postList');
        container.innerHTML = '<div class="empty-list">게시글을 불러오는데 실패했습니다.</div>';
        return;
      }

      const container = document.getElementById('postList');
      container.innerHTML = '';

      if (data.length === 0) {
        container.innerHTML = '<div class="empty-list">아직 게시글이 없습니다. 첫 번째 글을 작성해보세요!</div>';
        return;
      }

      data.forEach(post => {
        const item = document.createElement('div');
        item.className = 'post-item';

        const img = document.createElement('img');
        img.src = post.image_url || 'https://via.placeholder.com/60x60?text=No+Image';
        img.className = 'thumbnail';
        img.alt = '썸네일';

        const infoDiv = document.createElement('div');
        infoDiv.className = 'post-info';

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = post.title;
        
        const dateSpan = document.createElement('div');
        dateSpan.className = 'date';
        dateSpan.textContent = formatDate(post.created_at);
        
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'post-actions';
        
        const viewBtn = document.createElement('button');
        viewBtn.className = 'btn btn-view';
        viewBtn.textContent = '보기';
        viewBtn.onclick = () => window.location.href = `read.html?id=${post.id}`;
        
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-edit';
        editBtn.textContent = '수정';
        editBtn.onclick = () => window.location.href = `write.html?edit=${post.id}`;
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-delete';
        deleteBtn.textContent = '삭제';
        deleteBtn.onclick = () => deletePost(post.id);
        
        actionsDiv.appendChild(viewBtn);
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        
        infoDiv.appendChild(title);
        infoDiv.appendChild(dateSpan);
        
        item.appendChild(img);
        item.appendChild(infoDiv);
        item.appendChild(actionsDiv);
        container.appendChild(item);
      });
    }

    async function deletePost(postId) {
      if (!confirm('정말 삭제하시겠습니까?')) return;

      const { error } = await supabase.from('posts').delete().eq('id', postId);
      if (error) {
        alert('삭제 실패: ' + error.message);
      } else {
        alert('삭제되었습니다.');
        loadPosts();
      }
    }
    
    // 로그아웃 처리
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = 'board.html';
    });
  </script>
</body>
</html>