<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê¸€ ì‘ì„±í•˜ê¸°</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f8f8f8;
      padding: 20px;
      text-align: center;
    }
    .form-container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
    }
    input, textarea {
      width: 90%;
      margin: 10px 0;
      padding: 12px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 20px;
      padding: 12px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      background-color: #ffa07a;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .file-label {
      display: block;
      margin: 10px 0;
      font-weight: bold;
      text-align: left;
      margin-left: 5%;
    }
    .preview-image {
      max-width: 200px;
      max-height: 200px;
      margin: 10px auto;
      border-radius: 8px;
      display: none;
    }
    .file-upload-container {
      text-align: left;
      margin-left: 5%;
      margin-right: 5%;
      margin-bottom: 10px;
    }
    .back-btn {
      margin-top: 20px;
      padding: 12px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      background-color: #ccc;
      color: #333;
      font-weight: bold;
      cursor: pointer;
      margin-right: 10px;
    }
  </style>
</head>
<body>

  <div class="form-container">
    <h1 id="formTitle">ê¸€ ì‘ì„±í•˜ê¸°</h1>
    <input type="text" id="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
    <textarea id="content" rows="8" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    
    <div class="file-upload-container">
      <div class="file-label">ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
      <input type="file" id="imageUpload" accept="image/*" />
      <img id="imagePreview" class="preview-image" />
    </div>
    
    <div class="file-upload-container">
      <div class="file-label">íŒŒì¼ ì—…ë¡œë“œ (PDF, DOC, ë“±)</div>
      <input type="file" id="fileUpload" />
      <div id="fileInfo" style="margin-top: 5px; font-size: 0.8rem;"></div>
    </div>

    <div>
      <button class="back-btn" onclick="location.href='board.html'">ì·¨ì†Œ</button>
      <button id="saveBtn">ë“±ë¡í•˜ê¸°</button>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://lqkglbaqcnwbhvdjhwka.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxxa2dsYmFxY253Ymh2ZGpod2thIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4MDcxMzgsImV4cCI6MjA2MTM4MzEzOH0.c6Vt3XKENy6pDr2nBhJQz-M9tAQ1RZC3oTfg23ftLfI';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    

const author_email = 'salliground@gmail.com';

await supabase
  .from('posts')
  .insert([{
    title,
    content,
    image_url: imageUrl,
    author_email  // ğŸ‘ˆ ì´ ì¤„ ì¶”ê°€!
  }]);


    // ìˆ˜ì • ëª¨ë“œì¸ì§€ í™•ì¸
    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get('edit');
    let existingImageUrl = '';
    let existingFileUrl = '';
    
    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥
    document.getElementById('imageUpload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const preview = document.getElementById('imagePreview');
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });
    
    // íŒŒì¼ ì •ë³´ í‘œì‹œ
    document.getElementById('fileUpload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const fileInfo = document.getElementById('fileInfo');
        fileInfo.textContent = `ì„ íƒëœ íŒŒì¼: ${file.name} (${formatFileSize(file.size)})`;
      }
    });
    
    // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' bytes';
      else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      else return (bytes / 1048576).toFixed(1) + ' MB';
    }

    // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš° ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
    async function loadExistingPost() {
      if (!editId) return;
      
      document.getElementById('formTitle').textContent = 'ê¸€ ìˆ˜ì •í•˜ê¸°';
      document.getElementById('saveBtn').textContent = 'ìˆ˜ì •í•˜ê¸°';
      
      const { data, error } = await supabase
        .from('posts')
        .select('*')
        .eq('id', editId)
        .single();
        
      if (error) {
        alert('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      document.getElementById('title').value = data.title;
      document.getElementById('content').value = data.content;
      
      if (data.image_url) {
        existingImageUrl = data.image_url;
        const preview = document.getElementById('imagePreview');
        preview.src = data.image_url;
        preview.style.display = 'block';
      }
      
      if (data.file_url) {
        existingFileUrl = data.file_url;
        const fileInfo = document.getElementById('fileInfo');
        const fileName = data.file_url.split('/').pop().split('_').slice(1).join('_');
        fileInfo.textContent = `í˜„ì¬ íŒŒì¼: ${fileName}`;
      }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    if (editId) {
      loadExistingPost();
    }

    // íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜
    async function uploadFileToStorage(file, bucketName) {
      if (!file) return '';
      
      const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
      
      // íŒŒì¼ ì—…ë¡œë“œ
      const { data, error } = await supabase
        .storage
        .from(bucketName)
        .upload(fileName, file, {
          cacheControl: '3600',
          upsert: false
        });
        
      if (error) {
        console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
        throw error;
      }
      
      // ê³µê°œ URL ê°€ì ¸ì˜¤ê¸°
      const { data: publicUrlData } = supabase
        .storage
        .from(bucketName)
        .getPublicUrl(fileName);
        
      return publicUrlData.publicUrl;
    }

    // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById('saveBtn').addEventListener('click', async () => {
      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      const imageFile = document.getElementById('imageUpload').files[0];
      const docFile = document.getElementById('fileUpload').files[0];

      if (!title || !content) {
        alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      document.getElementById('saveBtn').disabled = true;
      document.getElementById('saveBtn').textContent = 'ì²˜ë¦¬ ì¤‘...';

      try {
        // ì´ë¯¸ì§€ ë° íŒŒì¼ ì—…ë¡œë“œ
        let imageUrl = existingImageUrl;
        let fileUrl = existingFileUrl;
        
        if (imageFile) {
          imageUrl = await uploadFileToStorage(imageFile, 'post-images');
        }
        
        if (docFile) {
          fileUrl = await uploadFileToStorage(docFile, 'post-files');
        }
        
        // ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
        let result;
        
        if (editId) {
          // ê²Œì‹œê¸€ ìˆ˜ì •
          result = await supabase
            .from('posts')
            .update({
              title,
              content,
              image_url: imageUrl,
              file_url: fileUrl
            })
            .eq('id', editId);
        } else {
          // ìƒˆ ê²Œì‹œê¸€ ì‘ì„±
          result = await supabase
            .from('posts')
            .insert([{
              title,
              content,
              image_url: imageUrl,
              file_url: fileUrl
            }]);
        }
        
        if (result.error) throw result.error;
        
        alert(editId ? 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        window.location.href = 'board.html';
        
      } catch (error) {
        alert(`${editId ? 'ìˆ˜ì •' : 'ë“±ë¡'} ì‹¤íŒ¨: ${error.message}`);
        console.error(error);
        document.getElementById('saveBtn').disabled = false;
        document.getElementById('saveBtn').textContent = editId ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°';
      }
    });
  </script>
</body>
</html>