<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>글쓰기</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; }
    label { display: block; margin-top: 1rem; }
    input, textarea, button { width: 100%; padding: 0.5rem; margin-top: 0.5rem; }
  </style>
</head>
<body>
  <h1>글쓰기</h1>
  <div id="auth-message"></div>
  <form id="postForm">
    <label>제목: <input type="text" id="title" required /></label>
    <label>내용: <textarea id="content" required></textarea></label>
    <label>이미지 업로드: <input type="file" id="image" accept="image/*" /></label>
    <label>파일 업로드: <input type="file" id="file" /></label>
    <button type="submit">등록하기</button>
  </form>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseClient = supabase.createClient(
      "https://lqkglbaqcnwbhvdjhwka.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxxa2dsYmFxY253Ymh2ZGpod2thIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4MDcxMzgsImV4cCI6MjA2MTM4MzEzOH0.c6Vt3XKENy6pDr2nBhJQz-M9tAQ1RZC3oTfg23ftLfI"
    );

    const postForm = document.getElementById('postForm');
    const authMessage = document.getElementById('auth-message');
    const allowedEmail = "salliground@gmail.com";

    async function sendMagicLinkLogin() {
      const { data, error } = await supabaseClient.auth.signInWithOtp({
        email: allowedEmail,
      });
      if (error) {
        authMessage.innerText = "로그인 링크 전송 실패: " + error.message;
      } else {
        authMessage.innerText = "이메일로 로그인 링크를 보냈습니다. 메일함을 확인해주세요.";
      }
    }

    async function checkUserAccess() {
      const {
        data: { session }
      } = await supabaseClient.auth.getSession();

      const user = session?.user;

      if (!user || user.email !== allowedEmail) {
        authMessage.innerText = "접근 권한이 없습니다. 로그인 링크를 보냅니다.";
        await sendMagicLinkLogin();
        postForm.style.display = "none";
        return;
      }

      authMessage.innerText = "환영합니다, " + user.email;
    }

    async function uploadFile(file, pathPrefix) {
      const fileExt = file.name.split('.').pop();
      const fileName = `${Date.now()}_${file.name}`;
      const filePath = `${fileName}`;

      const { data, error } = await supabaseClient.storage
        .from('post-images')
        .upload(filePath, file);

      if (error) throw error;

      const {
        data: { publicUrl }
      } = supabaseClient.storage.from('post-images').getPublicUrl(filePath);

      return publicUrl;
    }

    postForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      const image = document.getElementById('image').files[0];
      const file = document.getElementById('file').files[0];

      const {
        data: { session }
      } = await supabaseClient.auth.getSession();

      const currentUser = session?.user;
      if (!currentUser || currentUser.email !== allowedEmail) {
        alert("글쓰기 권한이 없습니다.");
        return;
      }

      let imageUrl = "";
      let fileUrl = "";

      try {
        if (image) imageUrl = await uploadFile(image, "images");
        if (file) fileUrl = await uploadFile(file, "files");

        const result = await supabaseClient
          .from('posts')
          .insert([{
            title,
            content,
            image_url: imageUrl,
            file_url: fileUrl,
            author: currentUser.email // ← ✅ 콤마 추가
          }]);

        if (result.error) {
          alert("등록 실패: " + result.error.message);
        } else {
          alert("글이 등록되었습니다.");
          location.href = "board.html";
        }
      } catch (error) {
        alert("에러: " + error.message);
      }
    });

    checkUserAccess();
  </script>
</body>
</html>
