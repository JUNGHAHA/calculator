<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>글쓰기 / 수정하기</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
    label { display: block; margin-top: 1rem; }
    input, textarea, button { width: 100%; padding: 0.5rem; margin-top: 0.5rem; }
    #content { min-height: 250px; }
    .button { display: inline-block; padding: 0.5rem 1rem; background-color: #4CAF50; color: white; border-radius: 4px; border: none; cursor: pointer; margin-top: 1rem; }
    .login-container { text-align: center; padding: 2rem; border: 1px solid #ddd; border-radius: 8px; margin-top: 2rem; }
    .editor-buttons { margin-bottom: 5px; display: flex; gap: 5px; }
    .editor-button { padding: 5px 10px; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 3px; cursor: pointer; }
    .url-input-container { display: none; margin-top: 5px; background: #f5f5f5; padding: 10px; border-radius: 4px; }
    #auth-message { margin: 1rem 0; padding: 0.5rem; background: #f8f8f8; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>글쓰기 / 수정하기</h1>
  <div id="auth-message"></div>
  <div id="login-section" class="login-container" style="display:none;">
    <p>관리자 로그인 필요</p>
    <input type="email" id="login-email" value="salliground@gmail.com" readonly />
    <button id="login-button" class="button">로그인 링크 받기</button>
  </div>

  <form id="postForm" style="display:none;">
    <label>제목: <input type="text" id="title" required /></label>
    <label>내용:</label>
    <div class="editor-buttons">
      <button type="button" class="editor-button" id="link-button">링크 추가</button>
    </div>
    <div id="url-input-container" class="url-input-container">
      <input type="text" id="url-text" placeholder="링크 텍스트" />
      <input type="url" id="url-link" placeholder="https://example.com" />
      <button type="button" id="insert-link" class="button">삽입</button>
      <button type="button" id="cancel-link" class="button" style="background:#888;">취소</button>
    </div>
    <textarea id="content" rows="10" required></textarea>

    <label>이미지 업로드: <input type="file" id="image" accept="image/*" /></label>
    <img id="previewImage" style="max-width:100%; margin-top:10px; display:none;" />

    <label>파일 업로드: <input type="file" id="file" /></label>
    <div id="fileNameDisplay" style="margin-top:5px; color:gray;"></div>

    <button type="submit" class="button">등록하기</button>
    <a href="board.html" class="button" style="background:#888;">취소</a>
  </form>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = supabase.createClient(
      'https://lqkglbaqcnwbhvdjhwka.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
    );
    const allowedEmail = "salliground@gmail.com";
    const editId = new URLSearchParams(location.search).get("edit");

    document.getElementById('link-button').onclick = () => {
      document.getElementById('url-input-container').style.display = 'block';
    };
    document.getElementById('cancel-link').onclick = () => {
      document.getElementById('url-input-container').style.display = 'none';
    };
    document.getElementById('insert-link').onclick = () => {
      const text = document.getElementById('url-text').value || document.getElementById('url-link').value;
      const url = document.getElementById('url-link').value;
      const markdown = `[${text}](${url})`;
      const textarea = document.getElementById('content');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      textarea.value = textarea.value.substring(0, start) + markdown + textarea.value.substring(end);
      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = start + markdown.length;
      document.getElementById('url-input-container').style.display = 'none';
    };

    document.getElementById('login-button').onclick = async () => {
      const email = document.getElementById('login-email').value;
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: window.location.href }
      });
      document.getElementById('auth-message').textContent = error ? error.message : '링크를 메일함에서 확인하세요.';
    };

    async function uploadToStorage(file) {
      const path = `${Date.now()}_${file.name}`;
      const { error } = await supabase.storage.from('post-files').upload(path, file);
      if (error) throw error;
      return supabase.storage.from('post-files').getPublicUrl(path).data.publicUrl;
    }

    async function checkSessionAndLoadForm() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session || session.user.email !== allowedEmail) {
        document.getElementById('login-section').style.display = 'block';
        return;
      }
      document.getElementById('postForm').style.display = 'block';
      if (editId) loadPostForEdit(editId);
    }

    async function loadPostForEdit(id) {
      const { data, error } = await supabase.from('posts').select('*').eq('id', id).single();
      if (error || !data) return alert('글을 불러오지 못했습니다.');

      document.getElementById('title').value = data.title;
      document.getElementById('content').value = data.content;
      if (data.image_url) {
        const img = document.getElementById('previewImage');
        img.src = data.image_url;
        img.style.display = 'block';
      }
      if (data.file_url) {
        document.getElementById('fileNameDisplay').textContent = '첨부됨: ' + data.file_name || '파일';
      }
    }

    document.getElementById('postForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      const image = document.getElementById('image').files[0];
      const file = document.getElementById('file').files[0];

      const { data: { session } } = await supabase.auth.getSession();
      const user = session.user;

      let imageUrl = null, fileUrl = null, fileName = null;
      if (image) imageUrl = await uploadToStorage(image);
      if (file) {
        fileUrl = await uploadToStorage(file);
        fileName = file.name;
      }

      const postData = {
        title,
        content,
        image_url: imageUrl,
        file_url: fileUrl,
        file_name: fileName,
        author_email: user.email
      };

      let result;
      if (editId) {
        result = await supabase.from('posts').update(postData).eq('id', editId);
      } else {
        result = await supabase.from('posts').insert(postData);
      }

      if (result.error) {
        alert("저장 실패: " + result.error.message);
      } else {
        alert(editId ? "수정되었습니다." : "등록되었습니다.");
        location.href = "board.html";
      }
    });

    document.addEventListener('DOMContentLoaded', checkSessionAndLoadForm);
  </script>
</body>
</html>
