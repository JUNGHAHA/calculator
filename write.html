<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>글쓰기</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
    label { display: block; margin-top: 1rem; }
    input, textarea, button { width: 100%; padding: 0.5rem; margin-top: 0.5rem; }
    .button { 
      display: inline-block;
      padding: 0.5rem 1rem;
      background-color: #4CAF50;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      margin-top: 1rem;
    }
    .login-container {
      text-align: center;
      padding: 2rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 2rem;
    }
    #auth-message {
      margin: 1rem 0;
      padding: 0.5rem;
      background-color: #f8f8f8;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>글쓰기</h1>
  <div id="auth-message"></div>
  <div id="login-section" class="login-container" style="display: none;">
    <p>게시판 글쓰기는 관리자만 가능합니다.</p>
    <input type="email" id="login-email" value="salliground@gmail.com" readonly />
    <button id="login-button" class="button">로그인 링크 받기</button>
  </div>

  <form id="postForm" style="display: none;">
    <label>제목: <input type="text" id="title" required /></label>
    <label>내용: <textarea id="content" rows="10" required></textarea></label>
    <label>이미지 업로드: <input type="file" id="image" accept="image/*" /></label>
    <label>파일 업로드: <input type="file" id="file" /></label>
    <div style="display: flex; gap: 10px; margin-top: 1rem;">
      <button type="submit" class="button">등록하기</button>
      <a href="board.html" class="button" style="background-color: #888;">취소</a>
    </div>
  </form>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = 'https://lqkglbaqcnwbhvdjhwka.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxxa2dsYmFxY253Ymh2ZGpod2thIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4MDcxMzgsImV4cCI6MjA2MTM4MzEzOH0.c6Vt3XKENy6pDr2nBhJQz-M9tAQ1RZC3oTfg23ftLfI';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    const postForm = document.getElementById('postForm');
    const authMessage = document.getElementById('auth-message');
    const loginSection = document.getElementById('login-section');
    const loginButton = document.getElementById('login-button');
    const allowedEmail = "salliground@gmail.com";

    // URL에서 파라미터 추출 함수
    function getParameterByName(name, url = window.location.href) {
      name = name.replace(/[\[\]]/g, '\\$&');
      var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
          results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    // Magic Link 로그인 설정
    loginButton.addEventListener('click', async () => {
      const email = document.getElementById('login-email').value;
      authMessage.innerText = "로그인 링크 전송 중...";
      
      try {
        const { data, error } = await supabaseClient.auth.signInWithOtp({
          email: email,
          options: {
            emailRedirectTo: 'https://parentscalc.com/write.html'
          }
        });
        
        if (error) throw error;
        authMessage.innerText = "이메일로 로그인 링크를 보냈습니다. 메일함을 확인해주세요.";
      } catch (error) {
        authMessage.innerText = "로그인 링크 전송 실패: " + error.message;
      }
    });

    // 로그인 상태 확인
    async function checkUserAccess() {
      const {
        data: { session }
      } = await supabaseClient.auth.getSession();

      const user = session?.user;

      if (!user || user.email !== allowedEmail) {
        postForm.style.display = "none";
        loginSection.style.display = "block";
        authMessage.innerText = "게시판 글쓰기를 위해 로그인이 필요합니다.";
        return false;
      }

      loginSection.style.display = "none";
      postForm.style.display = "block";
      authMessage.innerText = "환영합니다, " + user.email;
      return true;
    }

    // 파일 업로드 함수
    async function uploadFile(file) {
      const fileName = `${Date.now()}_${file.name}`;
      const filePath = fileName;

      const { data, error } = await supabaseClient.storage
        .from('post-images')
        .upload(filePath, file);

      if (error) throw error;

      const {
        data: { publicUrl }
      } = supabaseClient.storage.from('post-images').getPublicUrl(filePath);

      return publicUrl;
    }

    // 폼 제출 처리
    postForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      const image = document.getElementById('image').files[0];
      const file = document.getElementById('file').files[0];

      if (!title || !content) {
        alert("제목과 내용을 입력해주세요.");
        return;
      }

      const {
        data: { session }
      } = await supabaseClient.auth.getSession();

      const currentUser = session?.user;
      if (!currentUser || currentUser.email !== allowedEmail) {
        alert("글쓰기 권한이 없습니다.");
        return;
      }

      authMessage.innerText = "게시글 등록 중...";
      let imageUrl = null;
      let fileUrl = null;

      try {
        if (image) imageUrl = await uploadFile(image);
        if (file) fileUrl = await uploadFile(file);

        const { data, error } = await supabaseClient
          .from('posts')
          .insert([{
            title,
            content,
            image_url: imageUrl,
            file_url: fileUrl,
            author_email: currentUser.email
          }]);

        if (error) throw error;
        
        alert("글이 성공적으로 등록되었습니다.");
        window.location.href = "board.html";
      } catch (error) {
        alert("등록 실패: " + error.message);
        authMessage.innerText = "게시글 등록 실패: " + error.message;
      }
    });

    // 초기화
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // URL에서 access_token이 있는지 확인 (Magic Link로 돌아온 경우)
        const accessToken = getParameterByName('access_token');
        if (accessToken) {
          authMessage.innerText = "로그인 처리 중...";
          // 세션 설정
          const { data, error } = await supabaseClient.auth.setSession({
            access_token: accessToken,
            refresh_token: getParameterByName('refresh_token')
          });
          
          if (error) throw error;
          
          // 로그인 성공 후 URL 파라미터 제거
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      } catch (error) {
        console.error("세션 설정 오류:", error);
      }
      
      // 사용자 접근 권한 확인
      await checkUserAccess();
    });

    // 로그인 상태 변경 감지
    supabaseClient.auth.onAuthStateChange(async (event, session) => {
      if (event === 'SIGNED_IN') {
        await checkUserAccess();
      } else if (event === 'SIGNED_OUT') {
        loginSection.style.display = "block";
        postForm.style.display = "none";
        authMessage.innerText = "게시판 글쓰기를 위해 로그인이 필요합니다.";
      }
    });
  </script>
</body>
</html>