<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>글쓰기</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
    label { display: block; margin-top: 1rem; }
    input, textarea, button { width: 100%; padding: 0.5rem; margin-top: 0.5rem; }
    .button { 
      display: inline-block;
      padding: 0.5rem 1rem;
      background-color: #4CAF50;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      margin-top: 1rem;
    }
    .login-container {
      text-align: center;
      padding: 2rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 2rem;
    }
    #auth-message {
      margin: 1rem 0;
      padding: 0.5rem;
      background-color: #f8f8f8;
      border-radius: 4px;
    }
    .progress-bar {
      width: 100%;
      background-color: #f0f0f0;
      height: 20px;
      margin-top: 10px;
      border-radius: 4px;
      overflow: hidden;
      display: none;
    }
    .progress {
      height: 100%;
      background-color: #4CAF50;
      width: 0%;
      transition: width 0.3s;
    }
    .debug-info {
      font-size: 0.8rem;
      background-color: #f5f5f5;
      padding: 10px;
      margin-top: 20px;
      border-radius: 4px;
      text-align: left;
      max-width: 700px;
      margin: 20px auto;
      overflow-wrap: break-word;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <h1>글쓰기</h1>
  <div id="auth-message"></div>
  <div id="login-section" class="login-container" style="display: none;">
    <p>게시판 글쓰기는 관리자만 가능합니다.</p>
    <input type="email" id="login-email" value="salliground@gmail.com" readonly />
    <button id="login-button" class="button">로그인 링크 받기</button>
  </div>

  <form id="postForm" style="display: none;">
    <label>제목: <input type="text" id="title" required /></label>
    <label>내용: <textarea id="content" rows="10" required></textarea></label>
    <label>이미지 업로드: <input type="file" id="image" accept="image/*" /></label>
    <div id="image-progress" class="progress-bar">
      <div class="progress"></div>
    </div>
    <label>파일 업로드: <input type="file" id="file" /></label>
    <div id="file-progress" class="progress-bar">
      <div class="progress"></div>
    </div>
    <div style="display: flex; gap: 10px; margin-top: 1rem;">
      <button type="submit" class="button">등록하기</button>
      <a href="board.html" class="button" style="background-color: #888;">취소</a>
    </div>
  </form>

  <div id="debugInfo" class="debug-info"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = 'https://lqkglbaqcnwbhvdjhwka.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxxa2dsYmFxY253Ymh2ZGpod2thIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4MDcxMzgsImV4cCI6MjA2MTM4MzEzOH0.c6Vt3XKENy6pDr2nBhJQz-M9tAQ1RZC3oTfg23ftLfI';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    const postForm = document.getElementById('postForm');
    const authMessage = document.getElementById('auth-message');
    const loginSection = document.getElementById('login-section');
    const loginButton = document.getElementById('login-button');
    const debugInfo = document.getElementById('debugInfo');
    const allowedEmail = "salliground@gmail.com";

    // 디버그 정보 표시
    function showDebugInfo(message) {
      const time = new Date().toLocaleTimeString();
      debugInfo.innerHTML += `[${time}] ${message}<br>`;
      // 자동 스크롤
      debugInfo.scrollTop = debugInfo.scrollHeight;
    }

    // 버킷 존재 확인 및 생성 함수
    async function ensureBucketExists(bucketName) {
      try {
        showDebugInfo(`버킷 '${bucketName}' 확인 중...`);
        
        // 버킷 리스트 확인
        const { data: buckets, error: listError } = await supabaseClient.storage.listBuckets();
        
        if (listError) {
          showDebugInfo(`버킷 리스트 확인 오류: ${listError.message}`);
          return false;
        }
        
        // 버킷이 있는지 확인
        const bucketExists = buckets.some(bucket => bucket.name === bucketName);
        
        if (!bucketExists) {
          showDebugInfo(`'${bucketName}' 버킷이 없습니다. 생성 시도...`);
          
          // 버킷 생성 시도
          const { error: createError } = await supabaseClient.storage.createBucket(bucketName, {
            public: true,
            fileSizeLimit: 5242880 // 5MB
          });
          
          if (createError) {
            showDebugInfo(`버킷 생성 오류: ${createError.message}`);
            return false;
          }
          
          showDebugInfo(`'${bucketName}' 버킷이 생성되었습니다.`);
        } else {
          showDebugInfo(`'${bucketName}' 버킷이 이미 존재합니다.`);
        }
        
        return true;
      } catch (err) {
        showDebugInfo(`버킷 확인 중 예외 발생: ${err.message}`);
        return false;
      }
    }

    // URL에서 파라미터 추출 함수
    function getParameterByName(name, url = window.location.href) {
      name = name.replace(/[\[\]]/g, '\\$&');
      var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
          results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    // 파일명 정리 함수 - 안전한 파일명 생성
    function getSafeFileName(originalName) {
      // 타임스탬프 추가
      const timestamp = Date.now();
      
      // 파일 확장자 추출
      const lastDot = originalName.lastIndexOf('.');
      const ext = lastDot !== -1 ? originalName.substring(lastDot) : '';
      
      // 파일명에서 확장자 제외한 부분 추출
      const nameWithoutExt = lastDot !== -1 ? originalName.substring(0, lastDot) : originalName;
      
      // 특수문자 및 공백 제거하고 안전한 파일명 생성
      const safeName = nameWithoutExt
        .replace(/[^a-zA-Z0-9]/g, '_') // 영숫자 외 모든 문자를 언더스코어로 변경
        .replace(/_+/g, '_')          // 연속된 언더스코어를 하나로 합치기
        .substring(0, 30);            // 길이 제한
      
      return `${timestamp}_${safeName}${ext}`;
    }

    // Magic Link 로그인 설정
    loginButton.addEventListener('click', async () => {
      const email = document.getElementById('login-email').value;
      authMessage.innerText = "로그인 링크 전송 중...";
      
      try {
        const { data, error } = await supabaseClient.auth.signInWithOtp({
          email: email,
          options: {
            emailRedirectTo: window.location.href
          }
        });
        
        if (error) throw error;
        authMessage.innerText = "이메일로 로그인 링크를 보냈습니다. 메일함을 확인해주세요.";
      } catch (error) {
        authMessage.innerText = "로그인 링크 전송 실패: " + error.message;
      }
    });

    // 로그인 상태 확인
    async function checkUserAccess() {
      showDebugInfo("사용자 접근 권한 확인 중...");
      
      const {
        data: { session },
        error
      } = await supabaseClient.auth.getSession();

      if (error) {
        showDebugInfo(`세션 가져오기 오류: ${error.message}`);
        return false;
      }

      const user = session?.user;

      if (!user) {
        showDebugInfo("로그인된 사용자 없음");
        postForm.style.display = "none";
        loginSection.style.display = "block";
        authMessage.innerText = "게시판 글쓰기를 위해 로그인이 필요합니다.";
        return false;
      }
      
      showDebugInfo(`로그인된 사용자: ${user.email}`);

      if (user.email !== allowedEmail) {
        showDebugInfo("권한 없는 사용자 접근");
        postForm.style.display = "none";
        loginSection.style.display = "block";
        authMessage.innerText = "게시판 글쓰기는 관리자만 가능합니다.";
        return false;
      }

      showDebugInfo("관리자 접근 확인됨");
      loginSection.style.display = "none";
      postForm.style.display = "block";
      authMessage.innerText = "환영합니다, " + user.email;
      return true;
    }

    // 파일 업로드 함수
    async function uploadFile(file, bucketName, progressElement) {
      if (!file) return null;
      
      try {
        // 버킷 존재 확인/생성
        const bucketExists = await ensureBucketExists(bucketName);
        if (!bucketExists) {
          throw new Error(`${bucketName} 버킷에 접근할 수 없습니다.`);
        }
        
        // 안전한 파일명 생성
        const safeFileName = getSafeFileName(file.name);
        showDebugInfo(`파일 업로드 시작: ${safeFileName}`);
        
        // 진행 표시줄 표시
        if (progressElement) {
          progressElement.style.display = 'block';
          const progressBar = progressElement.querySelector('.progress');
          progressBar.style.width = '10%';
        }

        // 파일 업로드
        const { data, error } = await supabaseClient.storage
          .from(bucketName)
          .upload(safeFileName, file, {
            cacheControl: '3600',
            upsert: true
          });

        if (error) {
          showDebugInfo(`파일 업로드 오류: ${error.message}`);
          throw error;
        }

        // 진행 표시줄 100%
        if (progressElement) {
          const progressBar = progressElement.querySelector('.progress');
          progressBar.style.width = '100%';
        }
        
        showDebugInfo(`파일 업로드 성공: ${safeFileName}`);

        // 공개 URL 생성
        const { data: { publicUrl } } = supabaseClient.storage
          .from(bucketName)
          .getPublicUrl(safeFileName);

        showDebugInfo(`파일 공개 URL: ${publicUrl}`);
        return publicUrl;
      } catch (error) {
        showDebugInfo(`파일 업로드 과정 중 오류: ${error.message}`);
        if (progressElement) {
          progressElement.style.display = 'none';
        }
        throw error;
      }
    }

    // 폼 제출 처리
    postForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      const image = document.getElementById('image').files[0];
      const file = document.getElementById('file').files[0];
      const imageProgressBar = document.getElementById('image-progress');
      const fileProgressBar = document.getElementById('file-progress');

      if (!title || !content) {
        alert("제목과 내용을 입력해주세요.");
        return;
      }

      showDebugInfo("폼 제출 시작");
      
      const {
        data: { session }
      } = await supabaseClient.auth.getSession();

      const currentUser = session?.user;
      if (!currentUser || currentUser.email !== allowedEmail) {
        alert("글쓰기 권한이 없습니다.");
        showDebugInfo("권한 없는 사용자의 폼 제출 시도");
        return;
      }

      authMessage.innerText = "게시글 등록 중...";
      let imageUrl = null;
      let fileUrl = null;

      try {
        // 이미지 업로드
        if (image) {
          showDebugInfo("이미지 업로드 시작");
          imageUrl = await uploadFile(image, 'post-images', imageProgressBar);
        }
        
        // 파일 업로드
        if (file) {
          showDebugInfo("파일 업로드 시작");
          fileUrl = await uploadFile(file, 'post-files', fileProgressBar);
        }

        showDebugInfo("DB에 게시글 등록 시작");
        
        // 게시글 데이터베이스 등록
        const { data, error } = await supabaseClient
          .from('posts')
          .insert([{
            title,
            content,
            image_url: imageUrl,
            file_url: fileUrl,
            user_id: currentUser.id,
            author_email: currentUser.email
          }]);

        if (error) {
          showDebugInfo(`게시글 등록 오류: ${error.message}`);
          throw error;
        }
        
        showDebugInfo("게시글 등록 성공");
        alert("글이 성공적으로 등록되었습니다.");
        window.location.href = "board.html";
      } catch (error) {
        showDebugInfo(`게시글 등록 실패: ${error.message}`);
        alert("등록 실패: " + error.message);
        authMessage.innerText = "게시글 등록 실패: " + error.message;
      }
    });

    // 디버깅 모드 토글 버튼 추가
    function addDebugToggleButton() {
      const btn = document.createElement('button');
      btn.textContent = '디버깅 정보 표시/숨기기';
      btn.style.marginTop = '20px';
      btn.style.padding = '5px 10px';
      btn.style.background = '#f0f0f0';
      btn.style.border = '1px solid #ddd';
      btn.style.borderRadius = '4px';
      
      btn.addEventListener('click', () => {
        if (debugInfo.style.display === 'none') {
          debugInfo.style.display = 'block';
        } else {
          debugInfo.style.display = 'none';
        }
      });
      
      document.body.appendChild(btn);
    }

    // 초기화
    document.addEventListener('DOMContentLoaded', async () => {
      showDebugInfo("페이지 로드됨");
      addDebugToggleButton();
      
      try {
        // URL에서 access_token이 있는지 확인 (Magic Link로 돌아온 경우)
        const accessToken = getParameterByName('access_token');
        if (accessToken) {
          showDebugInfo("액세스 토큰 발견, 로그인 처리 중...");
          authMessage.innerText = "로그인 처리 중...";
          // 세션 설정
          const { data, error } = await supabaseClient.auth.setSession({
            access_token: accessToken,
            refresh_token: getParameterByName('refresh_token')
          });
          
          if (error) {
            showDebugInfo(`세션 설정 오류: ${error.message}`);
            throw error;
          }
          
          showDebugInfo("세션 설정 성공");
          // 로그인 성공 후 URL 파라미터 제거
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      } catch (error) {
        showDebugInfo(`세션 설정 오류: ${error.message}`);
        console.error("세션 설정 오류:", error);
      }
      
      // 사용자 접근 권한 확인
      await checkUserAccess();
    });

    // 로그인 상태 변경 감지
    supabaseClient.auth.onAuthStateChange(async (event, session) => {
      showDebugInfo(`인증 상태 변경: ${event}`);
      
      if (event === 'SIGNED_IN') {
        await checkUserAccess();
      } else if (event === 'SIGNED_OUT') {
        loginSection.style.display = "block";
        postForm.style.display = "none";
        authMessage.innerText = "게시판 글쓰기를 위해 로그인이 필요합니다.";
      }
    });
  </script>
</body>
</html>